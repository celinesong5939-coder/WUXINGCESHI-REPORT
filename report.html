<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ¯æ¡£æ¡ˆåº“ - V60.0 Cloud Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        :root { --c-bg: #020617; }
        body { background-color: var(--c-bg); background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%); color: #cbd5e1; font-family: 'Noto Serif SC', serif; min-height: 100vh; overflow-x: hidden; }
        
        /* æ–°ç‰ˆ3Då°è¡Œæ˜Ÿå›¾è…¾æ ·å¼ */
        .totem-container-3d {
            position: relative;
            width: 360px;
            height: 360px;
            margin: 0 auto;
            perspective: 1000px;
        }
        
        .totem-3d-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .planet-core {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 30% 30%, 
                rgba(255,255,255,0.8) 0%,
                currentColor 30%,
                rgba(0,0,0,0.8) 100%);
            box-shadow: 
                0 0 60px currentColor,
                0 0 100px rgba(255,255,255,0.2) inset,
                -20px -20px 40px rgba(0,0,0,0.8) inset;
            z-index: 20;
            animation: planet-rotate 20s linear infinite;
        }
        
        .planet-atmosphere {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 240px;
            height: 240px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, 
                rgba(255,255,255,0) 50%,
                currentColor 90%);
            opacity: 0.4;
            filter: blur(40px);
            z-index: 10;
            animation: atmosphere-pulse 4s ease-in-out infinite;
        }
        
        .planet-orbits {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
            z-index: 5;
        }
        
        .orbit-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 1px solid;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .orbit-ring-1 {
            width: 320px;
            height: 320px;
            border-color: currentColor;
            transform: translate(-50%, -50%) rotateX(60deg);
            animation: orbit-rotate-1 25s linear infinite;
        }
        
        .orbit-ring-2 {
            width: 280px;
            height: 280px;
            border-color: currentColor;
            transform: translate(-50%, -50%) rotateX(45deg) rotateY(30deg);
            animation: orbit-rotate-2 20s linear infinite reverse;
        }
        
        .wandering-orb {
            position: absolute;
            top: 0;
            left: 50%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px currentColor, 0 0 30px currentColor;
            z-index: 30;
        }
        
        .wandering-orb-1 {
            animation: wandering-orbit-1 8s linear infinite;
        }
        
        .wandering-orb-2 {
            animation: wandering-orbit-2 6s linear infinite reverse;
            width: 8px;
            height: 8px;
            opacity: 0.8;
        }
        
        .wandering-orbit-path {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) rotateX(70deg);
            z-index: 15;
        }
        
        .totem-metadata {
            position: absolute;
            bottom: -40px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 40;
        }
        
        .element-char {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(180deg, #fff 30%, currentColor 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 5px 30px rgba(0,0,0,0.8);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 25;
        }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes planet-rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes atmosphere-pulse {
            0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.05); }
        }
        
        @keyframes orbit-rotate-1 {
            0% { transform: translate(-50%, -50%) rotateX(60deg) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotateX(60deg) rotate(360deg); }
        }
        
        @keyframes orbit-rotate-2 {
            0% { transform: translate(-50%, -50%) rotateX(45deg) rotateY(30deg) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotateX(45deg) rotateY(30deg) rotate(360deg); }
        }
        
        @keyframes wandering-orbit-1 {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(160px) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(160px) rotate(-360deg); }
        }
        
        @keyframes wandering-orbit-2 {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(140px) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(140px) rotate(-360deg); }
        }
        
        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* æŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .report-card { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.05); padding: 2rem; margin-bottom: 2rem; border-radius: 4px; position: relative; overflow: hidden; }
        .report-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: rgba(255,255,255,0.1); }
        .section-num { position: absolute; top: 1rem; right: 1rem; font-size: 4rem; font-weight: 900; opacity: 0.05; line-height: 1; }
        .section-title { font-size: 1.5rem; font-weight: bold; color: #f1f5f9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .section-subtitle { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.5rem; display: block; }
        .report-content p { margin-bottom: 1rem; line-height: 1.8; text-align: justify; }
        .report-content strong { color: #e2e8f0; font-weight: bold; }
        .highlight { color: #d97706; }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .save-btn { position: fixed; bottom: 2rem; right: 2rem; width: 50px; height: 50px; background: #d97706; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; transition: transform 0.2s; }
        .save-btn:active { transform: scale(0.9); }
        
        /* CHAPTER7å›¾è…¾ç‰¹æ®Šæ ·å¼ */
        .chapter7-totem-container {
            width: 280px !important;
            height: 280px !important;
            margin: 2rem auto;
        }
        
        .chapter7-totem-container .planet-core {
            width: 120px;
            height: 120px;
        }
        
        .chapter7-totem-container .planet-atmosphere {
            width: 180px;
            height: 180px;
        }
        
        .chapter7-totem-container .planet-orbits {
            width: 240px;
            height: 240px;
        }
        
        .chapter7-totem-container .orbit-ring-1 {
            width: 240px;
            height: 240px;
        }
        
        .chapter7-totem-container .orbit-ring-2 {
            width: 200px;
            height: 200px;
        }
        
        .chapter7-totem-container .wandering-orbit-path {
            width: 140px;
            height: 140px;
        }
        
        .chapter7-totem-container .element-char {
            font-size: 3rem;
        }
    </style>
</head>
<body>
    <div id="report-app">

        <!-- çŠ¶æ€ä¸€ï¼šæ­£åœ¨åŠ è½½ -->
        <div v-if="isLoading" class="flex items-center justify-center h-screen text-slate-500">
            <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> æ­£åœ¨ä»äº‘ç«¯è§£å¯†æ¡£æ¡ˆ...
        </div>

        <!-- çŠ¶æ€äºŒï¼šå‘ç”Ÿé”™è¯¯ -->
        <div v-else-if="fetchError" class="flex flex-col items-center justify-center h-screen text-center px-4">
            <i class="fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-6"></i>
            <h2 class="text-2xl font-bold mb-2 text-white">æŠ¥å‘ŠåŠ è½½å¤±è´¥</h2>
            <p class="text-slate-400 max-w-sm">{{ fetchError }}</p>
        </div>

        <!-- çŠ¶æ€ä¸‰ï¼šæˆåŠŸåŠ è½½ -->
        <template v-else-if="reportData">
            <!-- æ‚¬æµ®ä¿å­˜æŒ‰é’® -->
            <div class="save-btn" @click="saveAsImage" title="ä¿å­˜ä¸ºå›¾ç‰‡"><i class="fa-solid fa-camera"></i></div>
            
            <div class="container mx-auto px-4 pb-20 max-w-3xl pt-12">
                <!-- å¤´éƒ¨ -->
                <header class="text-center mb-16 fade-in-up">
                    
                    <!-- é¡µé¢é¡¶éƒ¨3Då°è¡Œæ˜Ÿå›¾è…¾ -->
                    <div class="totem-container-3d mb-8" id="header-totem">
                        <!-- ç”±JavaScriptåŠ¨æ€æ¸²æŸ“ -->
                    </div>
                    
                    <div class="space-y-2">
                        <p class="text-amber-600 text-xs tracking-[0.5em] uppercase">Project Archetype V60 Cloud</p>
                        <h1 class="text-4xl font-black text-white tracking-widest">{{ reportData.comboName || 'äº”è¡Œäººæ ¼æŠ¥å‘Š' }}</h1>
                    </div>
                </header>

                <!-- æ·±åº¦è§£é‡Š -->
                <div class="mb-12 text-center px-8 py-6 bg-slate-900/50 rounded border border-amber-900/30 fade-in-up" style="animation-delay: 0.2s">
                    <p class="text-amber-500/80 text-xs font-bold uppercase tracking-widest mb-3">Archetype Disguise</p>
                    <div class="text-slate-300 text-sm leading-relaxed" v-html="reportData.hookText || 'ä½ çš„é¢å…·ä¸å†…æ ¸çš„ç‹¬ç‰¹é…ç½®'"></div>
                </div>

                <!-- ç« èŠ‚å†…å®¹ -->
                <div class="space-y-8" v-if="reportData.sections && reportData.sections.length > 0">
                    <section v-for="(section, index) in reportData.sections" :key="index" class="report-card fade-in-up" :style="{ animationDelay: ((index + 3) * 0.1) + 's' }">
                        <div class="section-num">{{ '0' + (index + 1) }}</div>
                        <div class="section-title">{{ section.title }}</div>
                        <span class="section-subtitle">{{ section.subtitle }}</span>
                        
                        <!-- æ˜¾ç¤ºç« èŠ‚å†…å®¹ -->
                        <div v-if="!section.sopData" class="report-content" v-html="section.content"></div>
                    </section>
                </div>
                
                <!-- å¦‚æœæ²¡æœ‰ç« èŠ‚æ•°æ®ï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º -->
                <div v-else class="text-center text-slate-500 mt-10">
                    <p>æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <footer class="text-center text-slate-600 text-xs mt-16 pb-8 border-t border-slate-900 pt-8">
                    <p>&copy; 2025 Source Code Archetype. All Rights Reserved.</p>
                </footer>
            </div>
        </template>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, nextTick } = Vue;

        const REPORT_FUNCTION_URL = 'https://cabsbodflwkohspatnck.supabase.co/functions/v1/report';
        
        // å·²å¡«å…¥ä½ çš„ Key
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhYnNib2RmbHdrb2hzcGF0bmNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTYyMzksImV4cCI6MjA4MjU3MjIzOX0.3b_2jnoJPB86ei8DdnGtQbw3iBPpynhoDGK1KrsEw7Y';

        // 3Då°è¡Œæ˜Ÿå›¾è…¾æ¸²æŸ“å‡½æ•° (ä¿æŒä¸å˜ï¼Œå› ä¸ºæ•ˆæœå¾ˆå¥½)
        function render3DTotem(totemData, containerId = 'header-totem', size = 'large') {
            const container = document.getElementById(containerId);
            if (!container || !totemData) return;
            
            // å®šä¹‰äº”è¡Œé¢œè‰²æ˜ å°„
            const colorMap = {
                metal: { 
                    color_hex: '#94a3b8',
                    glow_color: 'rgba(148, 163, 184, 0.7)',
                    text_color: '#f1f5f9'
                },
                wood: { 
                    color_hex: '#10b981',
                    glow_color: 'rgba(16, 185, 129, 0.7)',
                    text_color: '#d1fae5'
                },
                water: { 
                    color_hex: '#3b82f6',
                    glow_color: 'rgba(59, 130, 246, 0.7)',
                    text_color: '#dbeafe'
                },
                fire: { 
                    color_hex: '#ef4444',
                    glow_color: 'rgba(239, 68, 68, 0.7)',
                    text_color: '#fee2e2'
                },
                earth: { 
                    color_hex: '#f59e0b',
                    glow_color: 'rgba(245, 158, 11, 0.7)',
                    text_color: '#fef3c7'
                }
            };
            
            // å®šä¹‰äº”è¡Œå­—ç¬¦æ˜ å°„
            const charMap = {
                metal: 'âšª',
                wood: 'ğŸŸ¢',
                water: 'ğŸ”µ',
                fire: 'ğŸ”´',
                earth: 'ğŸŸ¡'
            };
            
            // å®šä¹‰äº”è¡Œåç§°æ˜ å°„
            const nameMap = {
                metal: 'é‡‘',
                wood: 'æœ¨',
                water: 'æ°´',
                fire: 'ç«',
                earth: 'åœŸ'
            };
            
            // ç¡®ä¿æœ‰é»˜è®¤å€¼
            const main = totemData.main || { 
                element: 'metal',
                name: 'é‡‘',
                char: 'âšª',
                color_hex: '#94a3b8'
            };
            
            const second = totemData.second || { 
                element: 'wood',
                name: 'æœ¨',
                char: 'ğŸŸ¢',
                color_hex: '#10b981'
            };
            
            const wandering = totemData.wandering || { 
                element: 'water',
                name: 'æ°´',
                char: 'ğŸ”µ',
                color_hex: '#3b82f6'
            };
            
            const balanced = totemData.balanced || { 
                name: 'å‡è¡¡',
                char: 'âš–',
                color_hex: '#94a3b8'
            };
            
            // å¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²å…ƒç´ ï¼Œè½¬æ¢ä¸ºå¯¹è±¡
            if (typeof main === 'string') {
                main.element = main;
                main.color_hex = colorMap[main]?.color_hex || '#94a3b8';
                main.char = charMap[main] || 'âšª';
                main.name = nameMap[main] || 'é‡‘';
            }
            
            if (typeof second === 'string') {
                second.element = second;
                second.color_hex = colorMap[second]?.color_hex || '#10b981';
                second.char = charMap[second] || 'ğŸŸ¢';
                second.name = nameMap[second] || 'æœ¨';
            }
            
            if (typeof wandering === 'string') {
                wandering.element = wandering;
                wandering.color_hex = colorMap[wandering]?.color_hex || '#3b82f6';
                wandering.char = charMap[wandering] || 'ğŸ”µ';
                wandering.name = nameMap[wandering] || 'æ°´';
            }
            
            // ç”Ÿæˆæ˜Ÿç©ºèƒŒæ™¯
            function generateStars(count) {
                let starsHTML = '';
                for (let i = 0; i < count; i++) {
                    const x = Math.random() * 100;
                    const y = Math.random() * 100;
                    const size = Math.random() * 2 + 1;
                    const opacity = Math.random() * 0.5 + 0.3;
                    const delay = Math.random() * 3;
                    starsHTML += `
                        <div class="star" style="
                            left: ${x}%;
                            top: ${y}%;
                            width: ${size}px;
                            height: ${size}px;
                            opacity: ${opacity};
                            animation-delay: ${delay}s;
                        "></div>
                    `;
                }
                return starsHTML;
            }
            
            // æ ¹æ®å°ºå¯¸è®¾ç½®å‚æ•°
            const sizes = {
                large: { 
                    container: '360px', 
                    planet: '160px', 
                    atmosphere: '240px',
                    orbit: '320px',
                    innerOrbit: '280px',
                    wanderingOrbit: '200px',
                    charSize: '4rem'
                },
                medium: { 
                    container: '280px', 
                    planet: '120px', 
                    atmosphere: '180px',
                    orbit: '240px',
                    innerOrbit: '200px',
                    wanderingOrbit: '140px',
                    charSize: '3rem'
                }
            };
            
            const style = sizes[size] || sizes.large;
            
            // æ„å»ºå›¾è…¾HTML
            const totemHTML = `
                <div class="totem-3d-wrapper" style="width: ${style.container}; height: ${style.container};">
                    <!-- èƒŒæ™¯æ˜Ÿç©º -->
                    <div class="stars">
                        ${generateStars(50)}
                    </div>
                    
                    <!-- å‰¯å±æ€§å…‰æ™• -->
                    <div class="planet-atmosphere" style="
                        width: ${style.atmosphere};
                        height: ${style.atmosphere};
                        color: ${second.color_hex};
                    "></div>
                    
                    <!-- è¡Œæ˜Ÿè½¨é“ -->
                    <div class="planet-orbits" style="width: ${style.orbit}; height: ${style.orbit};">
                        <div class="orbit-ring orbit-ring-1" style="
                            width: ${style.orbit};
                            height: ${style.orbit};
                            color: ${balanced.color_hex};
                        "></div>
                        <div class="orbit-ring orbit-ring-2" style="
                            width: ${style.innerOrbit};
                            height: ${style.innerOrbit};
                            color: ${balanced.color_hex};
                        "></div>
                        
                        <!-- æ¸¸ç¦»æ€è½¨é“è·¯å¾„ -->
                        <div class="wandering-orbit-path" style="
                            width: ${style.wanderingOrbit};
                            height: ${style.wanderingOrbit};
                            border-color: ${wandering.color_hex};
                        "></div>
                    </div>
                    
                    <!-- ä¸»å±æ€§è¡Œæ˜Ÿ -->
                    <div class="planet-core" style="
                        width: ${style.planet};
                        height: ${style.planet};
                        color: ${main.color_hex};
                    "></div>
                    
                    <!-- æ¸¸ç¦»æ€å°å…‰åœˆ -->
                    <div class="wandering-orb wandering-orb-1" style="color: ${wandering.color_hex};"></div>
                    <div class="wandering-orb wandering-orb-2" style="color: ${wandering.color_hex};"></div>
                    
                    <!-- äº”è¡Œå­—ç¬¦ -->
                    <div class="element-char" style="font-size: ${style.charSize}; color: ${main.color_hex};">${main.char}</div>
                </div>
                
                <!-- å›¾è…¾å…ƒæ•°æ® -->
                <div class="totem-metadata">
                    <div class="text-sm text-slate-400 space-y-1">
                        <div class="flex justify-center items-center space-x-6">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${main.color_hex}"></div>
                                <span>å†…æ ¸: ${main.name}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${second.color_hex}"></div>
                                <span>é¢å…·: ${second.name}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${wandering.color_hex}"></div>
                                <span>æ¸¸ç¦»æ€: ${wandering.name}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = totemHTML;
            
            // å¦‚æœæ˜¯CHAPTER7çš„å®¹å™¨ï¼Œæ·»åŠ ç‰¹æ®Šç±»
            if (containerId === 'chapter7-totem-container') {
                container.classList.add('chapter7-totem-container');
            }
        }

        // ===============================================
        // ä¿®æ”¹ç‰ˆï¼šCHAPTER7å›¾è…¾æ¸²æŸ“
        // ç°åœ¨ç›´æ¥è¯»å–åç«¯ä¼ å›æ¥çš„ data-m, data-s, data-w æ ‡ç­¾
        // ä¸å†éœ€è¦è§£æå¤æ‚çš„ JSON æˆ–è„šæœ¬
        // ===============================================
        function renderChapter7Totem() {
            // å°è¯•è·å–åç«¯ç”Ÿæˆçš„å ä½å®¹å™¨
            const container = document.getElementById('chapter7-totem-container');
            
            if (!container) {
                // å¦‚æœè¿˜æœªç”Ÿæˆï¼Œç¨åå†è¯•
                setTimeout(renderChapter7Totem, 500);
                return;
            }

            // è¯»å–æ•°æ®æ ‡ç­¾ (è¿™æ˜¯æ–°ç‰ˆåç«¯ç”Ÿæˆçš„å…³é”®æ•°æ®)
            const m = container.dataset.m;
            const s = container.dataset.s;
            const w = container.dataset.w;

            // å¦‚æœæ•°æ®å­˜åœ¨ï¼Œå¼€å§‹æ¸²æŸ“
            if (m && s && w) {
                // æ„å»ºå›¾è…¾æ•°æ®å¯¹è±¡
                const totemData = {
                    main: m,
                    second: s,
                    wandering: w,
                    balanced: { name: 'å‡è¡¡', char: 'âš–', color_hex: '#94a3b8' }
                };
                
                // è°ƒç”¨æ¸²æŸ“å¼•æ“
                render3DTotem(totemData, 'chapter7-totem-container', 'medium');
                
                // éšè—åŠ è½½åœˆ
                const loading = document.getElementById('totem-loading');
                if (loading) loading.style.display = 'none';
                
                console.log('CHAPTER7å›¾è…¾æ¸²æŸ“æˆåŠŸ', totemData);
            } else {
                console.log('CHAPTER7å®¹å™¨å·²å°±ç»ªï¼Œä½†ç­‰å¾…æ•°æ®å±æ€§æ³¨å…¥...');
                setTimeout(renderChapter7Totem, 500);
            }
        }

        // åˆå§‹åŒ–Vueåº”ç”¨
        createApp({
            setup() {
                const isLoading = ref(true);
                const fetchError = ref('');
                const reportData = ref(null);

                onMounted(async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    try {
                        const response = await fetch(`${REPORT_FUNCTION_URL}?${urlParams.toString()}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const rawData = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(rawData.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                        }

                        console.log("äº‘ç«¯åŸå§‹æ•°æ®:", rawData);

                        // å¤„ç†æ•°æ®
                        const coreData = rawData.attributes || rawData.meta || rawData;
                        const sectionsData = rawData.sections || coreData.sections || [];

                        reportData.value = {
                            ...rawData,
                            ...coreData,
                            attributes: coreData,
                            meta: coreData,
                            sections: sectionsData
                        };

                    } catch (error) {
                        console.error("åŠ è½½æŠ¥å‘Šå¤±è´¥:", error);
                        fetchError.value = error.message;
                    } finally {
                        isLoading.value = false;
                    }
                });
                
                // ç›‘å¬æŠ¥å‘Šæ•°æ®å˜åŒ–ï¼Œæ¸²æŸ“é¡µé¢é¡¶éƒ¨å›¾è…¾
                watch(() => reportData.value, (newValue) => {
                    if (newValue) {
                        nextTick(() => {
                            // ä¼˜å…ˆè¯»å–åç«¯ç›´æ¥è¿”å›çš„é¡¶å±‚å±æ€§ (m, s, w)
                            // è¿™è§£å†³äº†é¡¶éƒ¨æ˜Ÿçƒæ˜¾ç¤º undefined çš„é—®é¢˜
                            const mainElement = newValue.m || newValue.main?.element || 'metal';
                            const secondElement = newValue.s || newValue.second?.element || 'wood';
                            const wanderingElement = newValue.w || newValue.wandering?.element || 'water';
                            
                            const totemData = {
                                main: mainElement,
                                second: secondElement,
                                wandering: wanderingElement,
                                balanced: { name: 'å‡è¡¡', char: 'âš–', color_hex: '#94a3b8' }
                            };
                            
                            render3DTotem(totemData, 'header-totem', 'large');
                            
                            // è§¦å‘ C7 å›¾è…¾æ¸²æŸ“æ£€æŸ¥
                            if (newValue.sections && newValue.sections.length >= 7) {
                                setTimeout(() => {
                                    renderChapter7Totem();
                                }, 1000);
                            }
                        });
                    }
                }, { immediate: true });
                
                // ç›‘å¬ç« èŠ‚å†…å®¹å˜åŒ–ï¼Œå†æ¬¡ç¡®ä¿CHAPTER7å›¾è…¾æ¸²æŸ“
                watch(() => reportData.value?.sections, (newSections) => {
                    if (newSections && newSections.length >= 7) {
                        setTimeout(() => {
                            renderChapter7Totem();
                        }, 1500);
                    }
                }, { deep: true });

                const saveAsImage = () => {
                    alert("æˆªå›¾åŠŸèƒ½éœ€éƒ¨ç½²åœ¨æœåŠ¡å™¨ç¯å¢ƒä½¿ç”¨ (html2canvasè·¨åŸŸé™åˆ¶)ã€‚\nå½“å‰ç¯å¢ƒè¯·ç›´æ¥ä½¿ç”¨æµè§ˆå™¨æˆªå›¾ã€‚");
                };

                return { 
                    isLoading, 
                    fetchError, 
                    reportData, 
                    saveAsImage 
                };
            }
        }).mount('#report-app');
    </script>
</body>
</html>
