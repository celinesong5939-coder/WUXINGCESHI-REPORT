<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全息档案库 - 深度解码报告</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        :root { --c-bg: #020617; }
        body { 
            background-color: var(--c-bg); 
            background-image: radial-gradient(circle at 50% 0%, #172554 0%, #020617 60%); 
            color: #cbd5e1; 
            font-family: 'Noto Serif SC', serif; 
            min-height: 100vh; 
            overflow-x: hidden; 
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* ================== 图腾核心样式修复 ================== */
        /* 容器：相对定位，确保内部元素绝对定位准确 */
        .totem-container { 
            position: relative; 
            width: 300px; 
            height: 300px; 
            margin: 0 auto 3rem auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            /* 关键：防止方块背景出现 */
            background: transparent !important; 
        }

        /* 绝对居中通用类 */
        .abs-center { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            pointer-events: none;
        }
        
        /* 1. 光晕层 (最底层) */
        .totem-glow-main { width: 180px; height: 180px; border-radius: 50%; filter: blur(30px); opacity: 0.6; z-index: 1; animation: breathe 4s ease-in-out infinite; }
        .totem-glow-sub { width: 280px; height: 280px; border-radius: 50%; filter: blur(50px); opacity: 0.2; z-index: 0; animation: breathe 6s ease-in-out infinite reverse; }
        
        /* 2. 背景大图标 */
        .totem-bg-icon { font-size: 8rem; opacity: 0.15; z-index: 2; }

        /* 3. 能量环层 (核心修复：移除mask，使用border) */
        .totem-orbit-ring {
            width: 260px; height: 260px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.08);
            z-index: 3;
        }

        /* 4. 占比环 (Conic Gradient) */
        /* 修复：使用伪元素实现空心圆环，避免 mask 导致的黑洞 */
        .totem-chart-ring {
            width: 220px; height: 220px;
            border-radius: 50%;
            z-index: 4;
            /* 居中挖空逻辑 */
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
            mask: radial-gradient(transparent 65%, black 66%);
        }
        
        /* 5. 游离态轨道 */
        .totem-orbit-wrapper { width: 340px; height: 340px; z-index: 5; animation: spin 20s linear infinite; }
        .totem-planet { 
            position: absolute; top: 50%; right: -6px; 
            width: 14px; height: 14px; border-radius: 50%; 
            box-shadow: 0 0 15px currentColor; 
        }
        
        /* 6. 文字层 (最高层级，防止被遮挡) */
        .totem-char { 
            font-size: 5rem; 
            font-weight: 900; 
            z-index: 50; /* 极高层级 */
            text-shadow: 0 10px 40px rgba(0,0,0,0.8); 
            background-clip: text; 
            -webkit-background-clip: text; 
            color: transparent; 
            /* 兜底颜色，防止渐变失效看不见 */
            -webkit-text-fill-color: transparent;
        }
/* Chapter 7 专属修复 */
.chapter-totem .totem-container {
    transform: scale(0.8);
    margin: 1rem auto;
    /* 强制重置定位，防止飞出卡片 */
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
}

/* 确保后端生成的 HTML 里的文字颜色能正确显示 */
.totem-char {
    /* 确保渐变生效 */
    background-clip: text !important;
    -webkit-background-clip: text !important;
    color: transparent !important;
    /* 提高层级 */
    z-index: 100 !important;
}
        
        /* 动画定义 */
        @keyframes breathe { 0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.95); } 50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.05); } }
        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* ================== UI 排版优化 ================== */
        .report-card { 
            background: rgba(15, 23, 42, 0.4); 
            border: 1px solid rgba(255,255,255,0.05); 
            padding: 2.5rem; 
            margin-bottom: 3rem; 
            border-radius: 12px; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(20px); 
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
        }
        /* 顶部装饰条 */
        .report-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); }

        .section-num { position: absolute; top: -1rem; right: 0; font-size: 6rem; font-weight: 900; opacity: 0.03; font-family: sans-serif; pointer-events: none; }
        
        .section-title { font-size: 1.8rem; font-weight: bold; color: #f8fafc; margin-bottom: 0.5rem; display: flex; align-items: baseline; gap: 0.8rem; letter-spacing: 0.05em; }
        .section-subtitle { font-size: 0.85rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 2rem; display: block; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem; }
        
        /* 内容排版修正：拒绝拥挤 */
        .report-content { font-size: 1.05rem; color: #cbd5e1; }
        .report-content p { margin-bottom: 1.5rem; line-height: 1.9; text-align: left; /* 取消两端对齐，避免大缝隙 */ }
        .report-content strong, .report-content b { color: #fff; font-weight: 600; text-decoration: underline; text-decoration-color: rgba(217,119,6,0.5); text-underline-offset: 4px; }
        .report-content ul { list-style-type: none; padding-left: 0; margin-bottom: 1.5rem; }
        .report-content li { margin-bottom: 0.8rem; position: relative; padding-left: 1.5rem; }
        /* 列表项前的装饰点 */
        .report-content li::before { content: '•'; color: #d97706; position: absolute; left: 0; font-size: 1.2em; line-height: 1.5rem; }

        /* 针对后端生成的 Tailwind Grid 的兼容 */
        .grid { display: grid; gap: 1.5rem; }
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        .fade-in-up { animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(30px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* 截图按钮 */
        .save-btn { position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; background: linear-gradient(135deg, #d97706, #b45309); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 10px 25px rgba(217, 119, 6, 0.4); z-index: 100; transition: all 0.3s; font-size: 1.2rem; }
        .save-btn:hover { transform: scale(1.1) rotate(10deg); box-shadow: 0 15px 35px rgba(217, 119, 6, 0.6); }
    </style>
</head>
<body>
    <div id="report-app" class="min-h-screen">

        <!-- Loading -->
        <div v-if="isLoading" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-950 z-50">
            <div class="w-16 h-16 border-4 border-amber-900/30 border-t-amber-500 rounded-full animate-spin mb-6"></div>
            <div class="text-amber-600/80 text-xs tracking-[0.5em] uppercase animate-pulse">Accessing Akary Record...</div>
        </div>

        <!-- Error -->
        <div v-else-if="fetchError" class="flex flex-col items-center justify-center h-screen text-center px-4">
            <div class="text-6xl mb-6">⚠️</div>
            <h2 class="text-2xl font-bold mb-4 text-white">连接中断</h2>
            <p class="text-slate-400 max-w-sm mb-8 leading-relaxed">{{ fetchError }}</p>
            <a href="index.html" class="px-8 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-full text-white text-sm tracking-widest transition-all">重新连接</a>
        </div>

        <!-- Content -->
        <template v-else-if="reportData">
            <div class="save-btn" @click="screenshot"><i class="fa-solid fa-camera"></i></div>
            
            <div class="container mx-auto px-4 pb-32 max-w-4xl pt-16">
                <!-- Header Totem -->
                <header class="text-center mb-20 fade-in-up">
                    <div class="totem-container">
                        <!-- 1. 光晕 -->
                        <div class="totem-glow-main abs-center" :style="{ backgroundColor: reportData.main.color }"></div>
                        <div class="totem-glow-sub abs-center" :style="{ backgroundColor: reportData.second.color }"></div>
                        
                        <!-- 2. 物理轨道环 -->
                        <div class="totem-orbit-ring abs-center" :style="{ borderColor: reportData.main.color, opacity: 0.3 }"></div>
                        
                        <!-- 3. 占比环 (彩色) -->
                        <div class="totem-chart-ring abs-center" :style="conicGradientStyle"></div>
                        
                        <!-- 4. 游离行星 -->
                        <div class="totem-orbit-wrapper abs-center">
                            <div class="abs-center" style="width: 100%; height: 100%;">
                                <div class="totem-planet" :style="{ color: reportData.wandering.color, backgroundColor: reportData.wandering.color }"></div>
                            </div>
                        </div>
                        
                        <!-- 5. 背景图标 -->
                        <i :class="['totem-bg-icon', 'abs-center', reportData.main.icon]" :style="{ color: reportData.main.color }"></i>
                        
                        <!-- 6. 核心文字 (修复黑洞关键：z-index高，背景渐变) -->
                        <div class="totem-char abs-center" :style="{ backgroundImage: `linear-gradient(180deg, #fff 10%, ${reportData.main.color} 100%)` }">
                            {{ reportData.main.char }}
                        </div>
                    </div>
                    
                    <div class="space-y-4 mt-10">
                        <div class="inline-block px-3 py-1 border border-amber-900/50 rounded-full bg-amber-900/10">
                            <p class="text-amber-500 text-[10px] tracking-[0.4em] uppercase font-bold">Project Archetype V60</p>
                        </div>
                        <h1 class="text-4xl md:text-5xl font-black text-white tracking-widest drop-shadow-2xl">{{ reportData.comboName }}</h1>
                        <p class="text-slate-400 text-sm tracking-[0.2em] uppercase font-medium">{{ reportData.disguiseTitle }}</p>
                    </div>
                </header>

                <!-- 诊断书 (High-level Summary) -->
                <div class="mb-16 mx-auto max-w-2xl text-center px-8 py-10 bg-gradient-to-b from-slate-900/80 to-slate-900/40 rounded-xl border border-white/10 shadow-2xl fade-in-up" style="animation-delay: 0.2s">
                    <p class="text-amber-500 text-xs font-bold uppercase tracking-widest mb-6 flex justify-center items-center gap-3 opacity-80">
                        <span class="h-[1px] w-8 bg-amber-500/50"></span>
                        Archetype Diagnosis
                        <span class="h-[1px] w-8 bg-amber-500/50"></span>
                    </p>
                    <div class="text-slate-200 text-base leading-loose font-light" v-html="reportData.disguiseExplain"></div>
                </div>

                <!-- 章节内容 -->
                <div class="space-y-12" v-if="reportData.sections && reportData.sections.length > 0">
                    <section v-for="(section, index) in reportData.sections" :key="index" :class="['report-card', 'fade-in-up', {'chapter-totem': index === 6}]" :style="{ animationDelay: ((index + 3) * 0.1) + 's' }">
                        <div class="section-num">{{ '0' + (index + 1) }}</div>
                        <div class="section-title">
                            <span class="text-amber-500 text-sm align-middle mr-2">#</span>
                            {{ section.title }}
                        </div>
                        <span class="section-subtitle">{{ section.subtitle }}</span>
                        
                        <!-- 渲染内容 -->
                        <div class="report-content" v-html="fixContentHtml(section.content)"></div>
                    </section>
                </div>
                
                <footer class="text-center text-slate-700 text-xs mt-32 pb-8 border-t border-slate-900/50 pt-12 uppercase tracking-[0.2em]">
                    <p>&copy; 2026 Source Code Archetype. System Ver 60.0</p>
                </footer>
            </div>
        </template>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;
        const REPORT_FUNCTION_URL = 'https://cabsbodflwkohspatnck.supabase.co/functions/v1/report';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhYnNib2RmbHdrb2hzcGF0bmNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTYyMzksImV4cCI6MjA4MjU3MjIzOX0.3b_2jnoJPB86ei8DdnGtQbw3iBPpynhoDGK1KrsEw7Y';

        createApp({
            setup() {
                const isLoading = ref(true);
                const fetchError = ref('');
                const reportData = ref(null);

                // 数据清洗
                const normalizeAttribute = (attr) => {
                    if (!attr) return { color: '#64748b', char: '?', icon: '' };
                    const source = attr.totem || attr;
                    return {
                        ...attr,
                        color: source.color_hex || source.color || '#64748b',
                        char: source.char || '?',
                        icon: source.icon || 'fa-solid fa-circle',
                        name: source.name || source.label || ''
                    };
                };

                // 内容HTML修复函数：处理后端返回的HTML中可能存在的样式冲突
                const fixContentHtml = (html) => {
                    if (!html) return '';
                    // 移除后端可能硬编码的 text-center，让前端 CSS 控制排版
                    // 同时确保 Chapter 7 的图腾容器使用 relative 定位
                    let fixed = html.replace(/class="totem-container"/g, 'class="totem-container" style="position: relative !important; margin: 2rem auto;"');
                    // 修复 Chapter 7 可能存在的 abs-center 在卡片内定位不准的问题
                    // 这里我们假设后端生成的 HTML 结构是标准的，主要靠外部 CSS .chapter-totem 来约束
                    return fixed;
                };

                onMounted(async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    try {
                        const response = await fetch(`${REPORT_FUNCTION_URL}?${urlParams.toString()}`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                        });
                        const rawData = await response.json();
                        if (!response.ok) throw new Error(rawData.message || `Error: ${response.status}`);

                        const meta = rawData.meta || {};
                        reportData.value = {
                            comboName: meta.comboName || '未知组合',
                            disguiseTitle: meta.disguiseTitle || '',
                            disguiseExplain: meta.disguiseExplain || '',
                            main: normalizeAttribute(meta.main),
                            second: normalizeAttribute(meta.second),
                            wandering: normalizeAttribute(meta.wandering),
                            missing: normalizeAttribute(meta.missing),
                            equilibrium: normalizeAttribute(meta.equilibrium),
                            sections: rawData.sections || []
                        };
                    } catch (error) {
                        fetchError.value = error.message;
                    } finally {
                        isLoading.value = false;
                    }
                });
                
                const conicGradientStyle = computed(() => {
                    if (!reportData.value) return {};
                    const c1 = reportData.value.main.color;
                    const c2 = reportData.value.second.color;
                    const c3 = reportData.value.wandering.color;
                    return { background: `conic-gradient(${c1} 0% 60%, ${c2} 60% 90%, ${c3} 90% 100%)` };
                });

                const screenshot = () => alert("请使用手机截屏保存档案");

                return { isLoading, fetchError, reportData, conicGradientStyle, screenshot, fixContentHtml };
            }
        }).mount('#report-app');
    </script>
</body>
</html>

